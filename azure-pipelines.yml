trigger:
- master

pool:
  vmImage: 'macos-latest'

stages:
- stage: Build_And_Deploy
  jobs:
  - job: Build_Android
    displayName: 'Build Android APK'
    steps:
    - task: Gradle@2
      inputs:
        workingDirectory: ''
        gradleWrapperFile: 'gradlew'
        gradleOptions: '-Xmx3072m'
        publishJUnitResults: false
        testResultsFiles: '**/TEST-*.xml'
        tasks: 'assembleDebug'
    - task: CopyFiles@2
      displayName: 'Copy Files to: $(build.artifactStagingDirectory)'
      inputs:
        SourceFolder: ''
        Contents: '**/*.apk'
        TargetFolder: '$(build.artifactStagingDirectory)'
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'

- stage: Deploy
  displayName: Deploy Debug and Release Apps to App Center
  jobs:
    - deployment: Deploy_Android_Debug
      variables:
        buildConfiguration: Debug
      displayName: Deploy Android - Debug App
      pool:
        vmImage: $(vmImageName)
      environment: Staging
      strategy:
        runOnce:
          deploy:
            steps:
              - template: ionic-android-debug-deploy.yml
                parameters:
                  appCenterServiceConnection: 'new-appservice'
                  appSlug: 'saurabhAndroid/Android-App'
                  appFile: '$(Pipeline.Workspace)/$(projectName)/app-$(buildConfiguration).apk'
                  releaseNotes: 'Debug App'
